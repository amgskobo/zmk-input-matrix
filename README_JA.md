# ZMK Input Matrix (zip_matrix)

このモジュールは、トラックパッド（絶対座標 X/Y）を、設定可能な4方向フリック・グリッド・トリガーに変換する ZMK インプット・プロセッサです。

## 特徴

- **ダイナミック・グリッド**: 任意のサイズのグリッド（例：1x1, 2x2, 3x3, 4x3）を設定可能。
- **堅牢なトリガー**: 高精度なサイレンス・ウォッチドッグを使用してジェスチャーの完了を検出し、すべてのトラックパッド・ドライバーとの互換性を確保。
- **柔軟なイベント・フィルタリング**: `suppress-pointer` と `suppress-key` プロパティにより、ABS（ポインター）イベントと KEY（ボタン）イベントを独立して抑制可能。
- **非同期実行**: ZMK の behavior queue を使用してシーケンス化されたバインディング（例：複雑なマクロ）を入力のブロッキングなしに実行。
- **軽量な計算**: 高性能な Q16 固定小数点演算と最大軸比較により、MCU のオーバーヘッドを最小化。
- **1セルあたり5つのジェスチャー**: 中央（タップ）、北、南、西、東。

## インストール

このモジュールを `west.yml` に追加するか、ZMK 設定にコピーしてください。

## 使用方法

### 1. input_matrix.dtsi のインクルード

```dts
#include <input_matrix.dtsi>
```

### 2. オーバーレイの設定

`*.overlay`（または keymap）でプロセッサを定義し、インプット・リスナー（`trackpad_listener` など）に割り当てます。

**注**: Kconfig オプションを手動で有効にする必要はありません。オーバーレイで `zmk,input-processor-matrix` コンパチブル文字列を使用すると、モジュールは自動的に有効になります。

**例: 4x3 グリッド (標準 T9 レイアウト)**

```dts
/* プロセッサの定義 */
&zip_matrix {
    rows = <4>; cols = <3>;
    timeout-ms = <80>;
    flick-threshold = <50>;

    /* Row 0: 1, 2(ABC), 3(DEF) */
    cell_00 { bindings = <&kp N1 &kp UP &kp DOWN &kp LEFT &kp RIGHT>; };
    cell_01 { bindings = <&kp A  &kp C  &kp N2   &kp B    &kp A>; };
    cell_02 { bindings = <&kp D  &kp F  &kp N3   &kp E    &kp D>; };
    /* ... 他のセル ... */
};

/* リスナーへの割り当て */
&trackball_listener {
    input-processors = <&zip_matrix>;
};
```

## 設定リファレンス

### プロセッサ・プロパティ

| プロパティ | 型 | デフォルト | 説明 |
| :--- | :--- | :--- | :--- |
| `rows` | `int` | **必須** | 行数。 |
| `cols` | `int` | **必須** | 列数。 |
| `timeout-ms` | `int` | `80` | ジェスチャー終了を検出するまでの時間 (ms)。 |
| `flick-threshold` | `int` | `50` | フリックとタップを区別する最小ピクセル数。 |
| `suppress-pointer` | `bool` | `false` | `true` の場合、ABS イベントの伝播を停止（カーソル移動を無効化）。 |
| `suppress-key` | `bool` | `false` | `true` の場合、KEY イベントの伝播を停止（BTN_TOUCH クリックを無効化）。 |
| `x-min`/`x-max` | `int` | `0`/`1024` | 入力範囲。 |
| `y-min`/`y-max` | `int` | `0`/`1024` | 入力範囲。 |

## イベントの透過性と座標系

### 絶対座標 (ABS) と相対座標 (REL) の関係

`zip_matrix` は、ハードウェア・センサーからの **絶対座標 (ABS)** を処理するように設計されています。

- **ハードウェア・レベル**: 多くのタッチパッド等は、絶対的な位置（例：X: 0-1024, Y: 0-1024）を報告します。
- **zip_matrix**: これらの ABS イベントを処理して、どのグリッド・セルがタッチされているかを判断し、「フリック」（ABS 座標での大きな移動）を検出します。
- **標準的なマウス**: ZMK の標準的なマウス動作は、通常、コンバーターや別のインプット・プロセッサを使用して、ABS イベントを **相対的な (REL)** 移動量（デルタ）に変換して報告します。

### イベント・フローと透過性 (Transparency)

ZMK のインプット・プロセッサはチェーン（連鎖）を形成します。`zip_matrix` は、イベントを「消費」するか、チェーンの次のプロセッサへ「透過（パススルー）」させるかを選択できます。

| プロパティ | `true` の場合 (抑制) | `false` の場合 (透過) |
| :--- | :--- | :--- |
| `suppress-pointer` | ABS イベントを消費。カーソルは**動きません**。 | ABS イベントを透過。カーソルが**動きます**。 |
| `suppress-key` | KEY イベント（クリック等）を消費。BTN_TOUCH 等によるクリックを**発生させません**。 | KEY イベントを透過。BTN_TOUCH 等によるクリックが**発生します**。 |

> [!TIP]
> トラックパッドをマクロ・グリッド（T9 キーパッドなど）としてのみ使用する場合は、`suppress-pointer` と `suppress-key` の両方を `true` に設定します。
> マウスとして使いつつジェスチャー機能も持たせたい場合は、これらを `false` に設定し、`zip_matrix` を `input-processors` リストの中で **ABS から REL への変換が行われる前** に配置してください。
