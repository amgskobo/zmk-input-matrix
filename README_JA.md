# ZMK Input Matrix (zip_matrix)

このモジュールは、トラックパッド（絶対座標 X/Y）を、設定可能な4方向フリック・グリッド・トリガーに変換する ZMK インプット・プロセッサです。

## 特徴

- **ダイナミック・グリッド**: 任意のサイズのグリッド（例：1x1, 2x2, 3x3, 4x3）を設定可能。
- **BTN_TOUCH駆動トリガー**: 標準的な `BTN_TOUCH` キーイベントに即応してジェスチャーを確定。指が触れた瞬間から離れた瞬間までを正確にキャプチャします。
- **高精度なセッション同期**: `BTN_TOUCH` がオンになった後、XとYの両方の座標が揃うまでジェスチャー開始を待ち受けることで、初期位置の誤判定を防止。
- **柔軟なイベント・フィルタリング**: `suppress-abs` と `suppress-key` プロパティにより、ABS（ポインター）イベントと KEY（ボタン）イベントを独立して抑制可能。
- **非同期実行**: ZMK の behavior queue を使用してシーケンス化されたバインディング（例：複雑なマクロ）を入力のブロッキングなしに実行。
- **最適化された計算**: 移動中は代入のみ、確定時に1回のみ座標計算を行うことで、CPU負荷と電力消費を極小化。
- **1セルあたり5つのジェスチャー**: Tap（タップ）、Up（上）、Down（下）、Left（左）、Right（右）。
- **厳密な定義**: `x`, `y`, `threshold` を必須プロパティとすることで、曖昧さのない構成を実現。

## インストール

このモジュールを `west.yml` に追加するか、ZMK 設定にコピーしてください。

## 使用方法

### 1. input_matrix.dtsi のインクルード

```dts
#include <input_matrix.dtsi>
```

### 2. オーバーレイの設定

`*.overlay`（または keymap）でプロセッサを定義し、インプット・リスナー（`trackpad_listener` など）に割り当てます。

#### 例: 4x3 グリッド (標準 T9 レイアウト)

```dts
/* プロセッサの定義 */
&zip_matrix {
    rows = <4>;
    columns = <3>;
    threshold = <50>;
    x = <4095>;
    y = <4095>;

    /* 
     * 標準的な 12キー T9 レイアウト (4行 x 3列)
     * [00] [01] [02]
     * [03] [04] [05]
     * [06] [07] [08]
     * [09] [10] [11]
     */

    cell_00 { bindings = <&kp N1 &kp UP &kp DOWN &kp LEFT &kp RIGHT>; };
    cell_01 { bindings = <&kp A  &kp C  &kp N2   &kp B    &kp A>; };    /* Tap=A, Up=C, Down=N2, Left=B, Right=A */
    cell_02 { bindings = <&kp D  &kp F  &kp N3   &kp E    &kp D>; };
    
    /* ... など */
};

/* リスナーへの割り当て */
&trackpad_listener {
    input-processors = <&zip_matrix>;
};
```

## 設定リファレンス

### プロセッサ・プロパティ

| プロパティ | 型 | デフォルト | 説明 |
| :--- | :--- | :--- | :--- |
| `rows` | `int` | **必須** | グリッドの行数。 |
| `columns` | `int` | **必須** | グリッドの列数。 |
| `threshold` | `int` | **必須** | フリックとタップを区別する最小移動ピクセル数。 |
| `x` | `int` | **必須** | X軸の最大座標（範囲は 0 から x）。 |
| `y` | `int` | **必須** | Y軸の最大座標（範囲は 0 から y）。 |
| `suppress-abs` | `bool` | `false` | `true` の場合、ABS イベントの伝播を停止（カーソルの移動を抑制）。 |
| `suppress-key` | `bool` | `false` | `true` の場合、KEY イベントの伝播を停止（物理的なクリックの抑制）。 |

### 子ノードとグリッドのマッピング

ドライバーは、子ノードを **行優先順**（Row-Major Order: 左から右、上から下）でグリッドセルにマッピングします。

#### マッピングのロジック

1. **順序**: ドライバーは、子ノードを **定義された順序** （Devicetreeファイルに記述された順）に処理します。
2. **インデックス**: ノードはインデックス 0 から順にグリッドセルに割り当てられます。
    - `Index = (Row * Total_Cols) + Col`

**重要**: グリッドセルは定義順に割り当てられるため、混乱を避けるために `cell_00`, `cell_01`... `cell_11` のように連番で命名することを推奨します。

#### 5方向バインディングフォーマット

各子ノードは、以下の特定の順序で正確に5つのエントリを持つ `bindings` 配列を持つ必要があります：

1. **Tap** (タップ / フリックなし)
2. **Up** (上フリック)
3. **Down** (下フリック)
4. **Left** (左フリック)
5. **Right** (右フリック)

## イベントの透過性 (Transparency)

`zip_matrix` は、イベントを「消費」するか、チェーンの次のプロセッサへ「透過（パススルー）」させるかを選択できます。

| プロパティ | `true` の場合 (抑制) | `false` の場合 (透過) |
| :--- | :--- | :--- |
| `suppress-abs` | ABS イベントを消費。カーソルは**動きません**。 | ABS イベントを透過。カーソルが**動きます**。 |
| `suppress-key` | KEY イベントを消費。クリック等は**発生しません**。 | KEY イベントを透過。クリック等が**発生します**。 |

> [!TIP]
> トラックパッドをマクロ・グリッドとしてのみ使用する場合は、`suppress-abs` と `suppress-key` の両方を `true` に設定します。
> マウスとして使いつつジェスチャー機能も持たせたい場合は、これらを `false` に設定し、`zip_matrix` を `input-processors` の中で **ABS から REL への変換の前** に配置してください。
